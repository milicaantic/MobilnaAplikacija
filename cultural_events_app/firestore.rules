rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function hasValidStorableRole(role) {
      return role in ['user', 'admin'];
    }

    function isStandardUser() {
      return isSignedIn() && getUserRole() == 'user';
    }

    function hasInteractiveRole() {
      return isSignedIn() && hasValidStorableRole(getUserRole());
    }

    function isAdmin() {
      return isSignedIn() && (request.auth.token.admin == true || getUserRole() == 'admin');
    }

    function eventStatus(eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data.status;
    }

    function isEventApproved(eventId) {
      return eventStatus(eventId) == 'approved';
    }

    function isEventCountOnlyUpdate() {
      let oldCount = resource.data.eventCount is int ? resource.data.eventCount : 0;
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(['eventCount'])
             && request.resource.data.eventCount is int
             && request.resource.data.eventCount >= 0
             && (
               request.resource.data.eventCount == oldCount + 1
               || request.resource.data.eventCount == oldCount - 1
             );
    }

    function isEventCreator() {
      return isSignedIn() && request.auth.uid == resource.data.creatorId;
    }

    match /users/{userId} {
      allow read: if isSignedIn();

      // Guest is only a runtime unauthenticated state and cannot be stored.
      allow create: if isOwner(userId)
                    && request.resource.data.role == 'user';

      allow update: if (isOwner(userId)
                      && hasValidStorableRole(resource.data.role)
                      && request.resource.data.role == resource.data.role)
                    || (isAdmin() && hasValidStorableRole(request.resource.data.role));

      allow delete: if isAdmin() || isOwner(userId);
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() || (isSignedIn() && isEventCountOnlyUpdate());
      allow delete: if isAdmin() && resource.data.eventCount == 0;
    }

    match /events/{eventId} {
      allow read: if resource.data.status == 'approved'
                  || (isSignedIn() && request.auth.uid == resource.data.creatorId)
                  || isAdmin();

      allow create: if isSignedIn()
                    && request.resource.data.creatorId == request.auth.uid
                    && ((isStandardUser() && request.resource.data.status == 'pending')
                        || (isAdmin() && request.resource.data.status in ['pending', 'approved']));

      allow update: if isAdmin()
                    || (isEventCreator()
                        && request.resource.data.creatorId == resource.data.creatorId
                        && (
                          request.resource.data.status == resource.data.status
                          || (resource.data.status == 'rejected'
                              && request.resource.data.status == 'pending')
                        )
                        && request.resource.data.approvedBy == resource.data.approvedBy
                        && request.resource.data.approvedAt == resource.data.approvedAt
                        && request.resource.data.rejectedReason == resource.data.rejectedReason);

      allow delete: if isAdmin() || isEventCreator();

      match /comments/{commentId} {
        allow read: if isSignedIn();

        allow create: if hasInteractiveRole()
                      && isEventApproved(eventId)
                      && request.resource.data.userId == request.auth.uid;

        allow delete: if isSignedIn()
                      && (request.auth.uid == resource.data.userId || isAdmin());

        allow update: if isSignedIn()
                      && isEventApproved(eventId)
                      && (
                        (request.auth.uid == resource.data.userId
                         && request.resource.data.userId == resource.data.userId)
                        || isAdmin()
                      );
      }

      match /registrations/{userId} {
        allow read: if isSignedIn();

        allow create: if isOwner(userId)
                      && hasInteractiveRole()
                      && isEventApproved(eventId)
                      && request.resource.data.userId == request.auth.uid;

        allow delete: if isOwner(userId) || isAdmin();

        allow update: if false;
      }

      match /ratings/{userId} {
        allow read: if isSignedIn();

        allow create: if isOwner(userId)
                      && hasInteractiveRole()
                      && isEventApproved(eventId)
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;

        allow update: if isOwner(userId)
                      && hasInteractiveRole()
                      && isEventApproved(eventId)
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;

        allow delete: if isOwner(userId) || isAdmin();
      }
    }
  }
}
